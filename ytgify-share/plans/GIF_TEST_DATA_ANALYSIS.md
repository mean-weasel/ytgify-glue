# GIF Test Data - Current State Analysis

## Overview
The application has a well-structured system for managing GIF test data across fixtures, seed data, and persistent storage files.

---

## 1. Test Fixtures (test/fixtures/gifs.yml)

### Defined Records
The test fixtures define 4 GIF records for unit/integration tests:

| Fixture Name | User | Type | Description | Privacy |
|---|---|---|---|---|
| **alice_public_gif** | alice (user:one) | Original | "Alice's Funny Moment" from YouTube clip (10s-15s) | Public |
| **bob_public_gif** | bob (user:two) | Original | "Bob's Epic Clip" gaming moment (30s-35s) | Public |
| **bob_remix_of_alice** | bob (user:two) | Remix | Remix of alice_public_gif with text overlay | Public |
| **e2e_public_gif** | e2e_follower | Original | "E2E Test Public GIF" for system tests | Public |

### Key Fields in Fixtures
All fixtures use:
- **youtube_video_url** (NOT file attachments)
  - alice_public_gif: "https://www.youtube.com/watch?v=dQw4w9WgXcQ" (Rick Roll)
  - bob_public_gif: "https://www.youtube.com/watch?v=jNQXAC9IVRw" (Me at the zoo)
  - e2e_public_gif: "https://www.youtube.com/watch?v=dQw4w9WgXcQ" (Rick Roll)

- **YouTube Metadata**
  - youtube_video_title
  - youtube_channel_name
  - youtube_timestamp_start & youtube_timestamp_end
  
- **GIF Properties** (metadata only, no actual files)
  - duration, fps, resolution_width, resolution_height
  - file_size (metadata, not actual file)
  - has_text_overlay, text_overlay_data (JSON)
  
- **Engagement Counters**
  - view_count, like_count, comment_count, share_count
  
- **Soft Deletes**
  - deleted_at field (null for active GIFs)

---

## 2. Test Fixture Files

### Location
`test/fixtures/files/test.gif`

### File Details
- **Type**: GIF image data, version 89a
- **Dimensions**: 1 x 1 pixels (minimal test file)
- **Size**: 42 bytes (very small for testing)
- **Purpose**: Used in RemixProcessingJob tests to simulate file uploads without consuming storage

### Usage Pattern in Tests
```ruby
# Example from remix_processing_job_test.rb
test_file_path = Rails.root.join('test', 'fixtures', 'files', 'test.gif')
@remix.file.attach(
  io: StringIO.new(File.binread(test_file_path)),
  filename: 'test.gif'
)
```

**Note**: Tests use `StringIO.new(File.binread(path))` instead of direct file uploads to avoid race conditions in parallel test execution.

---

## 3. Development Seeds (db/seeds.rb)

### Creation Process
- Creates 5 test users
- Each user creates 6 GIFs
- Total: 30 GIFs created per seed run

### Seed Data Properties
- **Only YouTube Metadata** (no actual GIF files)
- YouTube URLs using sample video IDs:
  - "dQw4w9WgXcQ" (Rick Roll)
  - "jNQXAC9IVRw" (Me at the zoo)
  - "OPf0YbXqDm0" (Mark Ronson - Uptown Funk)
  - "kJQP7kiw5Fk" (Luis Fonsi - Despacito)
  - "9bZkp7q19f0" (PSY - Gangnam Style)

- Random timestamps between 0-120 seconds
- Privacy: 60% public, 20% unlisted, 20% private
- Associated with hashtags, likes, comments, follows, collections

---

## 4. Storage Files (Persistent Real GIF Files)

### Location
`storage/` directory (Rails default for ActiveStorage)

### Existing Real GIF Files

| File | Dimensions | File Size | Status |
|---|---|---|---|
| `storage/di/wb/diwbitjp17wbj0k57a4uwlhpzpl7` | 500 x 500 | 8.4 MB | GIF 89a |
| `storage/r8/zs/r8zsh4tiqkn7t3n6j3ytl4dowme5` | 500 x 500 | 8.5 MB | GIF 89a |
| `storage/sr/on/sron067p2qg60bl7r1tgbfv75l06` | 480 x 268 | 2.3 MB | GIF 89a |

**Total Storage**: ~19.2 MB

**Note**: These appear to be from actual development/testing sessions. The hash-like filenames are generated by Rails ActiveStorage (blob IDs).

---

## 5. GIF Model Architecture

### Schema (from db/migrate/20251106012538_create_gifs.rb)

```ruby
create_table :gifs, id: :uuid do |t|
  # Core metadata
  t.uuid :user_id              # Owner (with counter_cache)
  t.string :title              # Max 100 chars
  t.text :description          # Max 2000 chars

  # YouTube source data
  t.string :youtube_video_url
  t.string :youtube_video_title
  t.string :youtube_channel_name
  t.float :youtube_timestamp_start
  t.float :youtube_timestamp_end

  # GIF properties (metadata)
  t.float :duration
  t.integer :fps
  t.integer :resolution_width
  t.integer :resolution_height
  t.bigint :file_size          # Metadata, not validated against actual file

  # Text overlay
  t.boolean :has_text_overlay, default: false
  t.jsonb :text_overlay_data

  # Remix support
  t.boolean :is_remix, default: false
  t.uuid :parent_gif_id         # For remix chains
  t.integer :remix_count, default: 0

  # Privacy
  t.integer :privacy            # Enum: 0=public, 1=unlisted, 2=private

  # Engagement counters
  t.integer :view_count, default: 0
  t.integer :like_count, default: 0
  t.integer :comment_count, default: 0
  t.integer :share_count, default: 0

  # Soft delete
  t.datetime :deleted_at

  t.timestamps
end
```

### Key Field Notes

1. **File Attachment**: Uses `has_one_attached :file` (ActiveStorage)
   - NOT defined in migration (ActiveStorage manages separately)
   - Variants: :thumb (200x200), :medium (600x600)
   - Fixtures don't include actual files (optional)

2. **YouTube Source**: Required for original GIFs
   - Full YouTube URL stored
   - Metadata about timestamps (where clip extracted from)

3. **Metadata vs. Reality**: Important distinction
   - `duration`, `fps`, `resolution_*`, `file_size` are metadata fields
   - These can be different from actual file if not synced
   - Calculated automatically for YouTube clips (duration = end - start)

---

## 6. How Fixtures and Files Connect

### Current Implementation
1. **Fixture Records** = Database rows with metadata only
2. **Test File** = Minimal 42-byte GIF for attachment tests
3. **Storage Files** = Real GIFs for development/demonstration

### The Gap
- Test fixtures reference YouTube URLs, not file attachments
- When tests need to attach files, they use `test/fixtures/files/test.gif`
- Real application uses both YouTube metadata AND file attachments
- No automatic connection between fixture definitions and actual files

---

## 7. Test Data Best Practices (from CLAUDE.md)

### For Tests
```ruby
# Fixture-based tests (metadata only)
test "should show gif" do
  sign_in users(:one)
  get gif_path(gifs(:alice_public_gif))
  assert_response :success
end

# File attachment tests (use StringIO)
test "job processes file attachment" do
  test_file_path = Rails.root.join('test', 'fixtures', 'files', 'test.gif')
  @gif.file.attach(
    io: StringIO.new(File.binread(test_file_path)),
    filename: 'test.gif'
  )
  assert @gif.file.attached?
end
```

### Parallel Test Caution
- ActiveStorage attachments have race conditions in parallel mode
- Use `parallelize(workers: 1)` for file attachment tests
- Use StringIO instead of direct file references for reliability

---

## 8. Data Flow for Different Scenarios

### Scenario A: Unit Test (No Files)
1. Load fixture from gifs.yml
2. Get YouTube metadata + engagement counters
3. No file attachment needed
4. Fast, parallel-safe

### Scenario B: Controller Test (Optional File)
1. Load fixture or create in setup
2. Optionally attach test.gif using StringIO
3. Verify response/redirect behavior
4. Files not required

### Scenario C: Job Test (File Required)
1. Create GIF record in test setup
2. Attach test.gif using StringIO
3. Run job to process
4. Verify metadata/state changes
5. Disable parallelization (workers: 1)

### Scenario D: Development/Demo (Real Files)
1. Run `bin/rails db:seed`
2. Creates 30 GIF records with YouTube URLs
3. Stores in database (no files attached yet)
4. User can manually upload files or generate via API

---

## 9. Summary Statistics

| Item | Count | Details |
|---|---|---|
| **Fixture Records** | 4 | All with YouTube URLs, no files |
| **Test Fixture Files** | 1 | test.gif (42 bytes, 1x1 px) |
| **Storage GIF Files** | 3 | Real GIFs (2.3 - 8.5 MB each) |
| **Migration Indexes** | 8 | Performance optimized queries |
| **GIF Schema Fields** | 27 | Metadata + engagement + remix |
| **Counter Caches** | 3 | user.gifs_count, like/comment/view counts |
| **Default Seed GIFs** | 30 | Created per db:seed run (5 users × 6 GIFs) |

---

## 10. Recommendations for Populating with Real Data

### If You Want to Add GIF Files to Tests:
1. Create new GIF files (actual animated GIFs)
2. Add to `test/fixtures/files/`
3. Update test helper methods to reference them
4. Keep individual test files small (<1 MB)

### If You Want More Fixtures:
1. Add new records to `test/fixtures/gifs.yml`
2. Update counter cache columns in related fixtures (users, comments, etc.)
3. Ensure `deleted_at` is null for active GIFs

### If You Want Seed Data with Files:
1. Modify `db/seeds.rb` to generate GIF files
2. Use a library like `ruby-vips` or upload to S3
3. Attach files after GIF creation: `gif.file.attach(...)`
4. Consider file size/storage limits

---

## Quick Reference: Key File Locations

```
test/fixtures/gifs.yml              ← Fixture definitions (YouTube metadata)
test/fixtures/files/test.gif        ← Minimal test GIF file (42 bytes)
db/seeds.rb                         ← Development seed data script
db/migrate/*_create_gifs.rb         ← Schema definition
storage/                            ← ActiveStorage (real GIF files)
app/models/gif.rb                   ← Associations & validations
```

