name: Firefox Extension CI

on:
  workflow_call:
  workflow_dispatch:

defaults:
  run:
    working-directory: ytgify-firefox

jobs:
  test:
    name: Test and Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: .

      - name: Run linter
        run: npm run lint:code

      - name: Run type checking
        run: npm run typecheck

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: firefox-coverage
          path: ytgify-firefox/tests/coverage/
          retention-days: 7

      - name: Build extension
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firefox-build
          path: ytgify-firefox/dist/
          retention-days: 7

      - name: Check coverage thresholds
        run: |
          coverage_output=$(npm run test:coverage 2>&1)
          echo "$coverage_output"
          coverage=$(echo "$coverage_output" | grep "All files" | awk '{print $4}' | sed 's/%//')
          if [ -z "$coverage" ]; then
            echo "Could not extract coverage percentage, skipping threshold check"
            exit 0
          fi
          if (( $(echo "$coverage < 60" | bc -l) )); then
            echo "Coverage is below 60% threshold: ${coverage}%"
            exit 1
          else
            echo "Coverage is above threshold: ${coverage}%"
          fi

  mock-e2e-tests:
    name: E2E Tests (Shard ${{ matrix.shard }}/3)
    timeout-minutes: 15
    runs-on: ubuntu-latest
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - shard: 1
            pattern: "wizard-settings-matrix|error-handling|debug-frame-capture"
          - shard: 2
            pattern: "wizard-basic|gif-output-validation|debug-gif-parser"
          - shard: 3
            pattern: "newsletter-wizard|diagnostic-video|debug-gif-settings"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: .

      - name: Install Firefox and dependencies
        run: |
          sudo snap install firefox
          firefox --version
          npx geckodriver --version

      - name: Build extension
        run: npm run build

      - name: Install FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v2

      - name: Verify FFmpeg
        run: ffmpeg -version

      - name: Generate test videos
        run: npm run generate:test-videos

      - name: Run mock E2E tests (Shard ${{ matrix.shard }}/3)
        env:
          HEADLESS: true
        run: npm run test:selenium:mock -- --testPathPattern="${{ matrix.pattern }}"

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: firefox-e2e-shard-${{ matrix.shard }}
          path: |
            ytgify-firefox/tests/test-results/
            ytgify-firefox/tests/test-artifacts/
          retention-days: 7
