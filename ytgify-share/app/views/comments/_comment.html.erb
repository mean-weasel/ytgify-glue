<div id="<%= dom_id(comment) %>" class="flex space-x-3">
  <!-- User Avatar -->
  <%= link_to user_path(comment.user.username), class: "flex-shrink-0" do %>
    <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-semibold">
      <%= comment.user.username.first.upcase %>
    </div>
  <% end %>

  <!-- Comment Content -->
  <div class="flex-1 min-w-0">
    <div class="bg-gray-50 rounded-lg px-4 py-3">
      <!-- Username and Time -->
      <div class="flex items-center justify-between mb-1">
        <%= link_to user_path(comment.user.username), class: "font-semibold text-gray-900 hover:text-indigo-600" do %>
          <%= comment.user.display_name %>
        <% end %>
        <span class="text-xs text-gray-500">
          <%= time_ago_in_words(comment.created_at) %> ago
        </span>
      </div>

      <!-- Comment Body -->
      <p class="text-gray-700 whitespace-pre-line"><%= comment.content %></p>
    </div>

    <!-- Comment Actions -->
    <div class="flex items-center space-x-4 mt-2 px-2">
      <% if user_signed_in? %>
        <%= link_to "Reply",
            "#",
            onclick: "
              const form = document.getElementById('reply_form_#{comment.id}');
              if (form.innerHTML.trim() === '') {
                fetch('#{gif_comments_path(comment.gif)}?parent_comment_id=#{comment.id}', {
                  headers: { 'Accept': 'text/vnd.turbo-stream.html' }
                }).then(response => response.text())
                  .then(html => {
                    const template = document.createElement('template');
                    template.innerHTML = html.trim();
                    const frame = template.content.querySelector('turbo-frame');
                    if (frame) {
                      form.innerHTML = frame.innerHTML;
                    }
                  });
              }
              return false;
            ",
            class: "text-sm text-gray-600 hover:text-indigo-600 font-medium" %>

        <% if comment.has_replies? %>
          <span id="reply_count_#{comment.id}" class="text-sm text-gray-600">
            <%= comment.reply_count %> <%= comment.reply_count == 1 ? 'reply' : 'replies' %>
          </span>
        <% end %>
      <% end %>

      <% if user_signed_in? && current_user == comment.user %>
        <%= link_to "Edit",
            edit_comment_path(comment),
            data: { turbo_frame: dom_id(comment) },
            class: "text-sm text-gray-600 hover:text-indigo-600 font-medium" %>
      <% end %>

      <% if user_signed_in? && (current_user == comment.user || current_user == comment.gif.user) %>
        <%= button_to comment_path(comment),
            method: :delete,
            form: { data: { turbo_confirm: "Are you sure you want to delete this comment?" } },
            class: "text-sm text-gray-600 hover:text-red-600 font-medium" do %>
          Delete
        <% end %>
      <% end %>
    </div>

    <!-- Reply Form Placeholder -->
    <div id="reply_form_<%= comment.id %>" class="mt-4"></div>

    <!-- Nested Replies -->
    <% if comment.has_replies? %>
      <div id="replies_<%= comment.id %>" class="mt-4 space-y-4 pl-10 border-l-2 border-gray-200">
        <%= render partial: "comments/comment", collection: comment.replies.not_deleted.recent.limit(3) %>

        <% if comment.reply_count > 3 %>
          <button class="text-sm text-indigo-600 hover:text-indigo-700 font-medium pl-3">
            Load <%= comment.reply_count - 3 %> more <%= (comment.reply_count - 3) == 1 ? 'reply' : 'replies' %>...
          </button>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
