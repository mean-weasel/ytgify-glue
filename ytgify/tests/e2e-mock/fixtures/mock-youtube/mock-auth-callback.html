<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mock Auth Callback - YTGify Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
    }
    h1 { font-size: 24px; margin-bottom: 16px; }
    p { color: #666; margin-bottom: 24px; }
    .status { padding: 12px; border-radius: 4px; margin-top: 16px; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.pending { background: #fff3cd; color: #856404; }
    pre { text-align: left; background: #f8f9fa; padding: 12px; border-radius: 4px; font-size: 12px; overflow-x: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mock Auth Callback</h1>
    <p>This page simulates the OAuth callback for testing.</p>
    <div id="status" class="status pending">Initializing...</div>
    <pre id="debug"></pre>
  </div>

  <script>
    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const extensionId = urlParams.get('extensionId');
    const token = urlParams.get('token');
    const userDataEncoded = urlParams.get('userData');

    const statusEl = document.getElementById('status');
    const debugEl = document.getElementById('debug');

    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = 'status ' + type;
    }

    function log(message) {
      debugEl.textContent += message + '\n';
      console.log('[MockAuthCallback]', message);
    }

    async function sendAuthToExtension() {
      log('Extension ID: ' + extensionId);
      log('Token: ' + (token ? token.substring(0, 20) + '...' : 'null'));

      if (!extensionId) {
        showStatus('Error: No extension ID provided', 'error');
        log('ERROR: Missing extensionId parameter');
        return;
      }

      if (!token) {
        showStatus('Error: No token provided', 'error');
        log('ERROR: Missing token parameter');
        return;
      }

      // Parse user data if provided
      let userData = null;
      if (userDataEncoded) {
        try {
          userData = JSON.parse(decodeURIComponent(userDataEncoded));
          log('User data: ' + JSON.stringify(userData, null, 2));
        } catch (e) {
          log('Warning: Could not parse user data: ' + e.message);
        }
      }

      // Check if chrome.runtime is available
      if (typeof chrome === 'undefined' || !chrome.runtime || !chrome.runtime.sendMessage) {
        showStatus('Error: Chrome runtime not available', 'error');
        log('ERROR: chrome.runtime.sendMessage not available');
        log('This page must be loaded in Chrome with the extension installed');
        return;
      }

      showStatus('Sending auth to extension...', 'pending');
      log('Sending EXTENSION_AUTH_CALLBACK message...');

      // Set a timeout in case the response never comes
      let responseReceived = false;
      const timeoutId = setTimeout(() => {
        if (!responseReceived) {
          showStatus('Error: No response from extension (timeout)', 'error');
          log('ERROR: Timeout - no response after 5 seconds');
          log('This may indicate the extension is not accepting external messages');
        }
      }, 5000);

      try {
        chrome.runtime.sendMessage(
          extensionId,
          {
            type: 'EXTENSION_AUTH_CALLBACK',
            data: {
              token: token,
              user: userData
            }
          },
          function(response) {
            responseReceived = true;
            clearTimeout(timeoutId);

            log('Response received from extension');

            if (chrome.runtime.lastError) {
              showStatus('Error: ' + chrome.runtime.lastError.message, 'error');
              log('ERROR: ' + chrome.runtime.lastError.message);
              return;
            }

            if (response && response.success) {
              showStatus('Authentication successful!', 'success');
              log('SUCCESS: Auth callback received by extension');
            } else {
              showStatus('Error: ' + (response ? response.error : 'No response'), 'error');
              log('ERROR: ' + (response ? response.error : 'No response from extension'));
            }
          }
        );
        log('sendMessage called successfully');
      } catch (e) {
        responseReceived = true;
        clearTimeout(timeoutId);
        showStatus('Error: ' + e.message, 'error');
        log('EXCEPTION: ' + e.message);
      }
    }

    // Run on page load
    sendAuthToExtension();
  </script>
</body>
</html>
